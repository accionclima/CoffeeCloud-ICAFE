var utils = {
    addSelectOption: function (selectbox, value, text) {
        var optn = document.createElement("OPTION");
        optn.text = text;
        optn.value = value;
        selectbox.options.add(optn);
    },
    addPreSelectOption: function (selectbox, value, text) {
        var optn = document.createElement("OPTION");
        optn.text = text;
        optn.value = value;
        optn.selected = true;
        selectbox.options.add(optn);
    },
    clearSelect: function (selectbox) { selectbox.innerHTML = ""; },
    insertAfter: function (newNode, nodeRef) { nodeRef.parentNode.insertBefore(newNode, nodeRef.nextSibling); }
};


var muni14 = {
    data: [

	{dept:"San José",
		munis:["San José","Escazú","Desamparados","Puriscal","Tarrazú","Aserrí","Mora","Goicoechea","Santa Ana","Alajuelita","Vázquez de Coronado","Acosta","Tibás","Moravia","Montes de Oca","Turrubares","Dota","Curridabat","Pérez Zeledón","León Cortés"]},

	{dept:"Alajuela",
		munis:["Alajuela","San Ramón","Grecia","San Mateo","Atenas","Naranjo","Palmares","Poás","Orotina","San Carlos","Alfaro Ruiz","Valverde Vega","Upala","Los Chiles","Guatuso"]},

	{dept:"Cartago",
		munis:["Cartago","Paraíso","La Unión","Jiménez","Turrialba","Alvarado","Oreamuno","El Guarco"]},

	{dept:"Heredia",
		munis:["Heredia","Barva","Santo Domingo","Santa Bárbara","San Rafael","San Isidro","Belén","San Joaquín de Flores","San Pablo","Sarapiquí"]},

	{dept:"Guanacaste",
		munis:["Liberia","Nicoya","Santa Cruz","Bagaces","Carrillo","Cañas","Abangares","Tilarán","Nandayure","La Cruz","Hojancha"]},

	{dept:"Puntarenas",
		munis:["Puntarenas","Esparza","Buenos Aires","Montes de Oro","Osa","Aguirre","Golfito","Coto Brus","Parrita","Corredores","Garabito"]},

	{dept:"Limón",
		munis:["Limón","Pococí","Siquirres","Talamanca","Matina","Guácimo"]}


		],
    addDepts: function (selectDeptId) {
        var selectDept = document.getElementById(selectDeptId);
            deps = [];
            deps.push("");
        for (var i = 0, t = this.data.length; i < t; i++) {
            deps.push(this.data[i].dept);
        }
        deps.sort();

        for (var j = 0, t2 = deps.length; j < t2; j++) {
            utils.addSelectOption(selectDept, this.getDeptCode(deps[j]), deps[j])
        }



        var selectMunis = document.createElement("select");
        selectMunis.setAttribute("id", selectDept.getAttribute("id") + "-munis");
        selectMunis.setAttribute("class", "form-control");
        selectMunis.setAttribute("ng-model", "municipio");
        selectMunis.setAttribute("required", "required");
        selectMunis.setAttribute("data-error", "Campo Requerido");
        selectMunisCachedDisplay = selectMunis.style.display;
        selectMunis.style.display = "none";
        selectMunis.required = true;
        utils.insertAfter(selectMunis, selectDept);
        var that = this;
        selectDept.onchange = function () {
            var opt = this.value;
            if (opt > 0) {
                utils.clearSelect(selectMunis);
                utils.addSelectOption(selectMunis, " ", " ");
                var munis = that.data[--opt].munis;
                for (var i = 0, t = munis.length; i < t; i++) {
                    var code = i + 1;
                    utils.addSelectOption(selectMunis, code > 9 ? code : "0" + code, munis[i]);
                    selectMunis.style.display = selectMunisCachedDisplay
                }
            } else {
                utils.clearSelect(selectMunis); selectMunis.style.display = "none"
            }
        }
        selectDept.forcechange = function (opt,value) {
            if (opt > 0) {
                utils.clearSelect(selectMunis);
                utils.addSelectOption(selectMunis, " ", " ");
                var munis = that.data[--opt].munis;
                for (var i = 0, t = munis.length; i < t; i++) {
                    var code = i + 1;
                    var optval = munis[i];
                    if (optval == value)
                        utils.addPreSelectOption(selectMunis, code > 9 ? code : "0" + code, munis[i]);
                    else
                        utils.addSelectOption(selectMunis, code > 9 ? code : "0" + code, munis[i]);
                    selectMunis.style.display = selectMunisCachedDisplay
                }
            } else {
                utils.clearSelect(selectMunis);
                selectMunis.style.display = "none"
            }
        }
    },
    getDeptId: function (deptName) {
        console.log(this.data);
        var index = -1;
        for (var i = 0; i < this.data.length; i++) {
            var dname = this.data[i].dept;
            if (dname == deptName) {
                index = i;
            }
        }
        return index + 1;
    },
    getDept: function (id) {
        if (typeof id === "string") {
            id = parseInt(id, 10)
        } return (id > 0 && id < 15) ? this.data[--id].dept : ""
    },
    getMunis: function (deptId) {
        return this.getDept(deptId) !== "" ? this.data[--deptId].munis : ""
    },
    getDeptCode: function (dept) {
        for (var i = 0, t = this.data.length; i < t; i++) {
            if (this.data[i].dept === dept) {
                var code = ++i; return code > 9 ? code : "0" + code
            }
        }
    },
    getDeptMuni: function (code) {
        if (code.match(/\d{4}/)) {
            var deptCode = code.substring(0, 2),
                muniCode = parseInt(code.substring(2), 10) - 1,
                dept = muni14.getDept(deptCode);
            if (dept !== "" && muniCode >= 0) {
                var munis = this.getMunis(deptCode);
                return muniCode < munis.length ? dept + ", " + munis[muniCode] : ""
            }
        }
    }
};
